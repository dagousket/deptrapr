---
title: "flat_plot_dataset.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# `plot_dataset()` : show dataset as graphic

```{r function-plot_dataset}
#' plot_dataset
#'
#' @param data data.frame The data to plot, must have x and y numeric columns
#' @param type character The type of graph to return, either "plotly" or "ggplot"
#' @param smarties logical Should the plot have some candy flavour
#' @param title character Plot title
#' 
#' @importFrom ggplot2 ggplot aes geom_point theme_void labs
#' @importFrom plotly plot_ly
#' @importFrom ggthemes theme_pander
#' @importFrom RSkittleBrewer RSkittleBrewer
#' 
#' @return ggplot
#' @export
plot_dataset <- function(data,
                         type = c("ggplot", "plotly"),
                         smarties = FALSE,
                         title = "") {
  # get type
  type <- match.arg(type)
  
  # make plot
  if (type == "ggplot") {
    p <- ggplot(data, aes(x = x, y = y)) +
      labs(x = "x", y = "y", title = title)
    
    if (isTRUE(smarties)){
      p <- p +
        geom_point(
          size = 3,
          colour = sample(
            RSkittleBrewer(flavor = "smarties"),
            dim(data)[1],
            replace = TRUE
            )
          ) +
        theme_void()
      
    } else {
      p <- p +
        geom_point(size = 3) +
        theme_pander()
    }

  } else if (type == "plotly") {
    p <- plot_ly(
      data,
      x = ~ x,
      y = ~ y,
      type = "scatter",
      mode   = 'markers',
      marker = list(size = 10)
    )
  }
  
  return(p)
}
```

```{r examples-plot_dataset}
data <- fetch_dataset(type = "dino")
p <- plot_dataset(data,
                  type = "ggplot",
                  smarties = TRUE,
                  title = "My smarties dino")
p
```

```{r tests-plot_dataset}
test_that("plot_dataset works", {
  # load data
  data <- fetch_dataset(type = "dino")

  # test ggplot
  p <- plot_dataset(data, type = "ggplot")
  expect_s3_class(p, c("gg", "ggplot"))
  # test plotly
  p <- plot_dataset(data, type = "plotly")
  expect_s3_class(p, c("plotly", "htmlwidget"))
  
  })
```

# `save_plot()` : save graphic in chosen formats

```{r function-save_plot}
#' save_plot
#' 
#' @param plot ggplot A ggplot object to be saved
#' @param ext character A vector of output format, can be multiple of "png", "svg", "jpeg", "pdf"
#' @param path character A path where to save the output, will be created if it does not exist
#' @param filename character The filename fo rthe output, extension will be added
#' 
#' @importFrom fs dir_create
#' @importFrom purrr walk
#' @importFrom ggplot2 ggsave
#' @importFrom glue glue
#'
#' @return None Create output files
#' 
#' @export
save_plot <- function(
    plot,
    ext = c("png", "svg", "jpeg", "pdf"),
    path = "graph_output",
    filename = "output"
    ){
    
  ext <- match.arg(ext, several.ok = TRUE)
  
  # setup output dir
  dir_create(path)
  
  # save all format
  ext %>% walk(
    \(x) ggsave(
      filename = file.path(path, glue("{filename}.{x}")),
      plot = plot,
      device = x)
    )

}
```
  
```{r example-save_plot}
#' \dontrun{
save_plot(plot = p,
          filename = "dino")
#' }
```
  
```{r tests-save_plot}
test_that("save_plot works", {
  
  tmp_path <- tempfile(pattern = "saveplot")
  ext <- c("png", "svg", "jpeg", "pdf")
  
  data <- fetch_dataset(type = "dino")
  p <- plot_dataset(data,
                    type = "ggplot",
                    smarties = TRUE,
                    title = "My smarties dino")
  
  save_plot(plot = p,
            filename = "dino",
            ext = ext,
            path = tmp_path
            )
  
  # test files are created
  expected_files <- file.path(tmp_path, glue::glue("dino.{ext}"))
  expect_true(all(file.exists(expected_files)))
  
  # clean
  unlink(tmp_path, recursive = TRUE)
  
})
```
  


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_plot_dataset.Rmd", vignette_name = "Show dataset", check = FALSE)
```

